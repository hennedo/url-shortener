package main

import (
	"errors"
	"fmt"
	"math/rand"
	"net/http"
	"regexp"
	"time"

	"github.com/globalsign/mgo/bson"
	"github.com/go-bongo/bongo"
	"github.com/sirupsen/logrus"
)

var charset = []string {"0", "1", "2", "3", "4", "5", "6", "7", "8", "9", "a", "b", "c", "d", "e", "f", "g", "h", "i", "j", "k", "l", "m", "n", "o", "p", "q", "r", "s", "t", "u", "v", "w", "x", "y", "z", "A", "B", "C", "D", "E", "F", "G", "H", "U", "J", "K", "L", "M", "N", "O", "P", "Q", "R", "S", "T", "U", "V", "W", "X", "Y", "Z"}
var emojiCharset = []string {"ğŸ˜€","ğŸ˜ƒ","ğŸ˜„","ğŸ˜","ğŸ˜†","ğŸ˜Š","ğŸ˜‚","ğŸ˜…","ğŸ˜‡","ğŸ™‚","ğŸ™ƒ","ğŸ˜‰","ğŸ˜Œ","ğŸ˜š","ğŸ˜™","ğŸ˜—","ğŸ˜˜","ğŸ˜","ğŸ˜‹","ğŸ˜›","ğŸ˜","ğŸ˜œ","ğŸ¤ª","ğŸ¤©","ğŸ˜","ğŸ¤“","ğŸ§","ğŸ¤¨","ğŸ˜","ğŸ˜’","ğŸ˜","ğŸ˜”","ğŸ˜Ÿ","ğŸ˜–","ğŸ˜£","ğŸ™","ğŸ˜•","ğŸ˜«","ğŸ˜©","ğŸ˜¢","ğŸ˜­","ğŸ˜¤","ğŸ˜ ","ğŸ˜¡","ğŸ¤¬","ğŸ¤¯","ğŸ˜³","ğŸ˜“","ğŸ˜¥","ğŸ˜°","ğŸ˜¨","ğŸ˜±","ğŸ¤—","ğŸ¤”","ğŸ¤­","ğŸ¤«","ğŸ¤¥","ğŸ™„","ğŸ˜¬","ğŸ˜‘","ğŸ˜","ğŸ˜¶","ğŸ˜¯","ğŸ˜¦","ğŸ˜§","ğŸ˜®","ğŸ˜²","ğŸ¤","ğŸ˜µ","ğŸ˜ª","ğŸ¤¤","ğŸ˜´","ğŸ¤¢","ğŸ¤®","ğŸ¤§","ğŸ˜·","ğŸ¤’","ğŸ¤•","ğŸ¤‘","ğŸ¤ ","ğŸ˜ˆ","ğŸ‘¿","ğŸ‘»","ğŸ’©","ğŸ¤¡","ğŸ‘º","ğŸ‘¹","ğŸ’€","ğŸ‘½","ğŸ‘¾","ğŸ¤–","ğŸ˜»","ğŸ˜¹","ğŸ˜¸","ğŸ˜º","ğŸƒ","ğŸ˜¼","ğŸ˜½","ğŸ™€","ğŸ˜¿","ğŸ˜¾","ğŸ™Œ","ğŸ¤²","ğŸ‘","ğŸ‘","ğŸ¤","ğŸ¤›","âœŠ","ğŸ‘Š","ğŸ‘","ğŸ‘","ğŸ¤œ","ğŸ¤","ğŸ¤Ÿ","ğŸ¤˜","ğŸ‘‡","ğŸ‘†","ğŸ‘‰","ğŸ‘ˆ","ğŸ‘Œ","âœ‹","ğŸ¤š","ğŸ–","ğŸ––","ğŸ–•","ğŸ’ª","ğŸ¤™","ğŸ‘‹","ğŸ™","ğŸ’","ğŸ’„","ğŸ’‹","ğŸ‘„","ğŸ‘","ğŸ‘£","ğŸ‘ƒ","ğŸ‘‚","ğŸ‘…","ğŸ‘€","ğŸ§ ","ğŸ—£","ğŸ‘¤","ğŸ‘¥","ğŸ‘©","ğŸ‘¦","ğŸ§’","ğŸ‘§","ğŸ‘¶","ğŸ§‘","ğŸ‘¨","ğŸ‘±","ğŸ§”","ğŸ‘³","ğŸ‘²","ğŸ‘´","ğŸ§“","ğŸ‘µ","ğŸ§•","ğŸ‘®","ğŸ‘·","ğŸ’‚","ğŸ•µ","ğŸ³","ğŸŒ¾","ğŸ“","ğŸ¤","ğŸ’»","ğŸ­","ğŸ«","ğŸ’¼","ğŸ”§","ğŸš’","ğŸ¨","ğŸ”¬","ğŸš€","ğŸ‘¸","ğŸ¤µ","ğŸ‘°","ğŸ¤´","ğŸ¤¶","ğŸ…","ğŸ§™","ğŸ§Ÿ","ğŸ§›","ğŸ§","ğŸ§œ","ğŸ‘—","ğŸ‘”","ğŸ‘–","ğŸ‘•","ğŸ‘š","ğŸ‘™","ğŸ‘˜","ğŸ‘ ","ğŸ‘¡","ğŸ‘¢","ğŸ§£","ğŸ§¤","ğŸ§¦","ğŸ‘Ÿ","ğŸ‘","ğŸ©","ğŸ§¢","ğŸ‘’","â›‘","ğŸ‘œ","ğŸ‘›","ğŸ‘","ğŸ‘‘","ğŸ’","ğŸ‘“","ğŸ•¶","ğŸŒ‚","ğŸ¶","ğŸ±","ğŸ­","ğŸ¹","ğŸ°","ğŸ¯","ğŸ¨","ğŸ¼","ğŸ»","ğŸ¦Š","ğŸ¦","ğŸ®","ğŸ·","ğŸ½","ğŸ¸","ğŸ’","ğŸ™Š","ğŸ™‰","ğŸ™ˆ","ğŸµ","ğŸ”","ğŸ§","ğŸ¦","ğŸ¤","ğŸ£","ğŸ¦‡","ğŸ¦‰","ğŸ¦…","ğŸ¦†","ğŸ¥","ğŸº","ğŸ—","ğŸ´","ğŸ¦„","ğŸ","ğŸ","ğŸš","ğŸŒ","ğŸ¦‹","ğŸ›","ğŸœ","ğŸ¦—","ğŸ•·","ğŸ•¸","ğŸ¦‚","ğŸ¦•","ğŸ¦–","ğŸ¦","ğŸ","ğŸ¢","ğŸ™","ğŸ¦‘","ğŸ¦","ğŸ¦€","ğŸ¡","ğŸ‹","ğŸ³","ğŸ¬","ğŸŸ","ğŸ ","ğŸ¦ˆ","ğŸŠ","ğŸ…","ğŸ†","ğŸ¦“","ğŸ«","ğŸª","ğŸ¦","ğŸ˜","ğŸ¦","ğŸ¦’","ğŸƒ","ğŸ‚","ğŸ„","ğŸ","ğŸ¦Œ","ğŸ","ğŸ‘","ğŸ","ğŸ–","ğŸ•","ğŸ©","ğŸˆ","ğŸ“","ğŸ¦ƒ","ğŸ¿","ğŸ€","ğŸ","ğŸ‡","ğŸ•Š","ğŸ¦”","ğŸ¾","ğŸ‰","ğŸ²","ğŸŒµ","ğŸŒ±","ğŸŒ´","ğŸŒ³","ğŸŒ²","ğŸ„","ğŸŒ¿","â˜˜","ğŸ€","ğŸ","ğŸ‹","ğŸ„","ğŸ","ğŸ‚","ğŸƒ","ğŸ’","ğŸŒ·","ğŸŒ¹","ğŸ¥€","ğŸŒº","ğŸŒ","ğŸŒ","ğŸŒ»","ğŸŒ¼","ğŸŒ¸","ğŸŒ›","ğŸŒœ","ğŸŒš","ğŸŒ•","ğŸŒ–","ğŸŒ“","ğŸŒ’","ğŸŒ‘","ğŸŒ˜","ğŸŒ—","ğŸŒ”","ğŸŒ™","ğŸŒ","ğŸŒ","ğŸŒ","âœ¨","ğŸŒŸ","â­","ğŸ’«","ğŸ’¥","ğŸ”¥","ğŸŒª","ğŸŒˆ","ğŸŒ¥","â›…","ğŸŒ¤","ğŸŒ¦","ğŸŒ§","â›ˆ","ğŸŒ©","ğŸŒ¨","ğŸ’¨","ğŸŒ¬","â›„","ğŸ’§","ğŸ’¦","ğŸŒŠ","ğŸŒ«","ğŸ","ğŸ","ğŸ","ğŸŠ","ğŸ‹","ğŸˆ","ğŸ“","ğŸ‡","ğŸ‰","ğŸŒ","ğŸ’","ğŸ‘","ğŸ","ğŸ¥¥","ğŸ¥","ğŸ¥’","ğŸ¥¦","ğŸ¥‘","ğŸ†","ğŸ…","ğŸŒ¶","ğŸŒ½","ğŸ¥•","ğŸ¥”","ğŸ ","ğŸ§€","ğŸ¥¨","ğŸ¥–","ğŸ","ğŸ¥","ğŸ¥š","ğŸ¥","ğŸ¥“","ğŸ¥©","ğŸŸ","ğŸ”","ğŸŒ­","ğŸ–","ğŸ—","ğŸ•","ğŸ¥ª","ğŸ¥™","ğŸŒ®","ğŸŒ¯","ğŸ¥—","ğŸ¥˜","ğŸ¥«","ğŸ","ğŸœ","ğŸ¥Ÿ","ğŸ±","ğŸ£","ğŸ›","ğŸ²","ğŸ¤","ğŸ™","ğŸš","ğŸ˜","ğŸ¥","ğŸ¨","ğŸ§","ğŸ¡","ğŸ¢","ğŸ¥ ","ğŸ¦","ğŸ¥§","ğŸ°","ğŸ‚","ğŸ®","ğŸ©","ğŸ¿","ğŸ«","ğŸ¬","ğŸ­","ğŸª","ğŸŒ°","ğŸ¥œ","ğŸ¯","ğŸ¥›","ğŸ¶","ğŸ¥¤","ğŸ¼","ğŸº","ğŸ»","ğŸ¥‚","ğŸ·","ğŸ¥ƒ","ğŸ´","ğŸ¥„","ğŸ¾","ğŸ¹","ğŸ¸","ğŸ½","ğŸ¥£","ğŸ¥¡","ğŸ¥¢","ğŸ¾","ğŸˆ","ğŸ€","âš½","ğŸ","ğŸ‰","ğŸ±","ğŸ“","ğŸ¸","â›³","ğŸ","ğŸ‘","ğŸ’","ğŸ¥…","ğŸ¹","ğŸ£","ğŸ¥Š","ğŸ½","â›·","ğŸ¿","ğŸ›·","ğŸ¥Œ","â›¸","ğŸ‚","ğŸ¤¼","ğŸ†","ğŸ¥‡","ğŸ¥ˆ","ğŸ¥‰","ğŸ«","ğŸ—","ğŸµ","ğŸ–","ğŸ…","ğŸŸ","ğŸª","ğŸ­","ğŸ¼","ğŸ§","ğŸ¬","ğŸ¹","ğŸ¥","ğŸ·","ğŸº","ğŸ¸","ğŸ®","ğŸ³","ğŸ¯","ğŸ²","ğŸ»","ğŸ°","ğŸš—","ğŸš•","ğŸš™","ğŸšŒ","ğŸš","ğŸš","ğŸš‘","ğŸš“","ğŸ","ğŸšš","ğŸš›","ğŸšœ","ğŸ›´","ğŸš²","ğŸš","ğŸš”","ğŸš¨","ğŸ","ğŸ›µ","ğŸš˜","ğŸš–","ğŸš¡","ğŸš ","ğŸš„","ğŸš","ğŸš","ğŸš‹","ğŸšƒ","ğŸš…","ğŸšˆ","ğŸš‚","ğŸš‡","ğŸ›¬","ğŸ›«","ğŸš‰","ğŸšŠ","ğŸ›©","ğŸ’º","ğŸ›°","ğŸ›¸","ğŸ›³","â›´","ğŸš¢","â›½","ğŸ—º","ğŸš","ğŸš¥","ğŸš¦","ğŸš§","ğŸ—¿","ğŸ—½","ğŸ—¼","ğŸ°","ğŸ¯","â›²","ğŸ ","ğŸ¢","ğŸ¡","ğŸŸ","â›±","ğŸ–","ğŸ","ğŸœ","â›º","ğŸ•","ğŸ—»","ğŸ”","â›°","âŒš","ğŸ“±","ğŸ–¥","ğŸ–¨","ğŸ—œ","ğŸ’½","ğŸ“¼","ğŸ“·","ğŸ“½","ğŸ","ğŸ“ ","ğŸ“º","ğŸ›","â±","ğŸ”¦","ğŸ’¡","ğŸ“","ğŸ“¸","ğŸ’¶","ğŸ’´","ğŸ’µ","ğŸ’¸","ğŸ”«","ğŸ’£","ğŸš¬","ğŸŠ","ğŸ‰","ğŸ®","ğŸ","ğŸ’Š","ğŸš¿","ğŸ—","ğŸš°","ğŸ”‘","ğŸ›","ğŸ›","ğŸ›’", "â¤ï¸", "ğŸ§¡","ğŸ’›","ğŸ’š","ğŸ’™","ğŸ’œ","ğŸ–¤","ğŸ’¯","âœ…","â","ğŸ’¤","â”","â“","â•","â—"}

func getUniqueRandomString(length int, emoji bool) (string, error) {
Start:
	name := randomString(length, emoji)
	link := &Link{}
	err := connection.Collection("links").FindOne(bson.M{"Name": name}, link)
	if _, ok := err.(*bongo.DocumentNotFoundError); ok {
		return name, nil
	} else if err != nil {
		return "", err
	} else {
		goto Start
	}
}

func randomString(length int, emoji bool) string {
	r := rand.New(rand.NewSource(time.Now().UnixNano()))
	randomString := ""
	if emoji {
		for i := 0; i < length; i++ {
			randomString += emojiCharset[r.Intn(len(emojiCharset))]
		}
	} else {
		for i := 0; i < length; i++ {
			randomString += charset[r.Intn(len(charset))]
		}
	}
	return randomString
}


func getLink(name string) (error, *Link) {
	link := &Link{}
	err := connection.Collection("links").FindOne(bson.M{"name": name}, link)
	if _, ok := err.(*bongo.DocumentNotFoundError); ok {
		logrus.Info(fmt.Sprintf("Short \"%s\" not found", name))
		return errors.New("404"), nil
	}
	return err, link
}
func addHttp(url string) string {
	r := regexp.MustCompile("^(((f|ht)tps?)|tg)://")
	if !r.MatchString(url) {
		url = "http://" + url
	}
	return url
}

func returnError500(err error, w http.ResponseWriter) {
	logrus.Error(err)
	w.WriteHeader(http.StatusInternalServerError)
	_, _ = fmt.Fprintf(w, "Internal Server error..")
}

func returnError404(w http.ResponseWriter) {
	w.WriteHeader(http.StatusNotFound)
	_, _ = fmt.Fprintf(w, "404 Document not found.")
}
func returnError401(w http.ResponseWriter) {
	w.WriteHeader(http.StatusUnauthorized)
	_, _ = fmt.Fprintf(w, "Unauthorized.")
}
